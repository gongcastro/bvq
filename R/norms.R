#' Generate item-level norms for age, sex, language profile and item dominance
#'
#' This function generates a data frame with the estimated proportion of
#' children that understand and/or produce some items for a selected age range
#' and participant profiles. Estimated proportions and corresponding standard
#' errors and confidence intervals are computed adjusting for zero- and
#' one-inflation (see functions [prop_adj()], [prop_adj_se()], and
#' [prop_adj_ci()]).
#'
#' @export bvq_norms
#'
#' @importFrom dplyr mutate
#' @importFrom dplyr filter
#' @importFrom dplyr select
#' @importFrom dplyr left_join
#' @importFrom dplyr group_by_at
#' @importFrom dplyr between
#' @importFrom dplyr summarise
#' @importFrom dplyr rowwise
#' @importFrom dplyr arrange
#' @importFrom tidyr pivot_longer
#' @importFrom tidyr drop_na
#' @param responses Responses data frame, as generated by [bvq_responses()].
#' @param participants Participants data frame, as generated by
#'   [bvq_participants()].
#' @param item Character string indicating the item to compute norms for. If
#'   left `NULL` (default) norms will be computed for all items. You can check
#'   the available items in the [pool] data set running `data("pool")`.
#' @param language Character string indicating the language to compute
#'   vocabulary norms for: `"catalan"` and/or `"spanish"`.
#' @param type Character string indicating the vocabulary type to compute norms
#'   for. Takes `"understands"` and/or `"produces"` (defaults to both).
#' @param age Numeric vector of length two (min-max) indicating the age range of
#'   participants to compute norms for.
#' @param lp character string indicating the language profile of participants to
#'   compute norms for: `"Bilingual"`, `"Monolingual"`, `"Other"` (defaults to
#'   all).
#' @param sex character string indicating the sex of participants to compute
#'   norms for. Takes `"Female"` and/or `"Male"` (defaults to both).
#' @param semantic_category character string indicating the semantic/functional
#'   category or categories to include items from. See available categories in
#'   the `pool` data set by running `data("pool")`.
#' @param .width Numeric values ranging from 0 to 1 (not included) indicating
#'   the confidence level of confidence intervals (defaults to `0.95`).
#' @param ... Unused
#'
#' @returns A data frame (actually, a [tibble::tibble] with the proportion of
#'   participants in the sample that understand or produce the items indicated
#'   in `item`, along with the standard error and confidence interval of the
#'   estimation. The output contains the following variables:
#' * te: an integer identifying the Translation Equivalent (a.k.a., pair of cross-language synonyms, doublets) the item belongs to.
#' * item: character string indicating the item identifier (e.g., `spa_mesa`). This value is unique for each item. Responses to the same item from different participants are linked by the same `item` value.
#' * language: a character string indicating the language the item response belongs to: `"Catalan"` if item in Catalan), `"Spanish"` if item in Spanish.
#' * age: an integer indicating the age of participants (in months) for which the estimates should be computed. If a non-integer is provided (e.g., `15.36`, it is rounded downwards using [floor()].)
#' * type: a character string indicating the vocabulary type computed: `"understands"` if option 'Understands' was selected, and `"produces"` if option 'Understands & Says' was selected.
#' * lp: a character string indicating participants' language profile, classified using parental reports of language exposure (see `doe_spanish`, `"doe_catalan`, and `doe_others`), and the thresholds passed in the `bilingual_threshold` and `other_threshold`.
#' * semantic_category: a character string indicating the semantic/function category the item belongs to (e.g., `"Vehicles"`, `"Actions"`).
#' * item_dominance: a character string that takes the value `"L1"` if the item belongs to participants' language of most exposure, and L2 if the item belongs to participants' language of least exposure.
#' * label: a character string indicating the text presented to participants in the questionnaire (replacing the `item` identifier).
#' * .prop: a numeric value ranging from 0 to 1 (both included) indicating the estimated proportion of participants that provided a positive response, adjusted following Gelman et al.'s method to account for zero- and one-inflation (see function [prop_adj]).
#' * .n: a positive integer indicating the total number number of responses (useful for computing proportions).
#'
#' @author Gonzalo Garcia-Castro
#' @md
bvq_norms <- function(participants,
                      responses,
                      item = NULL,
                      language = c("Catalan", "Spanish"),
                      type = c("understands", "produces"),
                      age = NULL,
                      lp = c("Bilingual", "Monolingual", "Other"),
                      sex = c("Female", "Male"),
                      semantic_category = NULL,
                      .width = 0.95,
                      ...) {
    
    # get logs
    logs <- bvq_logs(participants = participants, 
                     responses = responses)
    
    group_vars <- c("te", "item", "language", "age", "type", "lp",
                    "semantic_category", "item_dominance", "label")
    
    if (is.null(item)) item <- unique(responses$item)
    if (is.null(semantic_category)) sem_cat <- unique(pool$semantic_category)
    if (is.null(age)) age <- floor(range(responses$age))
    
    norms <- responses %>%
        left_join(select(logs, id, time, lp),
                  by = join_by(id, time),
                  multiple = "all") %>%
        filter(item %in% .env$item,
               lp %in% .env$lp,
               between(age, .env$age[1], .env$age[2])) %>%
        mutate(understands = response %in% 2:3,
               produces = response==3) %>%
        select(id, age, sex, lp, dominance, item, understands, produces) %>%
        pivot_longer(c(understands, produces),
                     names_to = "type", 
                     values_to = "response") %>%
        mutate(age = floor(age)) %>% 
        left_join(select(pool, te, item, language, label, semantic_category), 
                  multiple = "all",
                  by = join_by(item)) %>%
        filter(language %in% .env$language,
               type %in% .env$type,
               semantic_category %in% sem_cat) %>%
        mutate(item_dominance = case_when(
            language==dominance ~ "L1",
            language!=dominance ~ "L2")) %>%
        drop_na(response) %>%
        group_by_at(group_vars) %>% 
        summarise(.yes = sum(response, na.rm = TRUE),
                  .n = sum(!is.na(response), na.rm = TRUE),
                  .groups = "drop") %>%
        mutate(.prop = prop_adj(.yes, .n)) %>% 
        arrange(te, item, language, lp, item_dominance, type, age, 
                .prop, .n)
    
    return(norms)
    
}




















