#' Download formr surveys
#'
#' @importFrom cli cli_progress_done
#' @importFrom cli cli_progress_step
#' @importFrom cli cli_progress_update
#' @importFrom cli qty
#' @importFrom formr formr_raw_results
#'
#' @param surveys Name of the surveys in the formr run.
#' @param ... Unused.
#' 
#' @author Gonzalo Garcia-Castro
#' 
#' @noRd
#' @keywords internal
#' 
#' @md
download_surveys <- function(surveys, ...) {
    n <- length(surveys)
    i <- 0
    raw <- vector(mode = "list", length = n)
    
    if (interactive()) {
        step_msg <- "Downloaded {i}/{n} {qty(i)}survey{?s}"
        cli_progress_step(msg = step_msg)
    }
    
    for (i in seq_along(surveys)) {
        raw[[i]] <- formr_raw_results(surveys[i])
        if (interactive()) cli_progress_update()
    }
    
    if (interactive()) cli_progress_done(result = "done")
    
    raw <- lapply(raw, select, -any_of("language"))
    names(raw) <- surveys
    
    return(raw)
}

#' Process survey contents
#'
#' @param raw Raw survey data, as generated by [bvq::download_surveys()]
#' @param participants_tmp Participants dataset, inherited from inside the `import_*()` function environment.
#' @param survey_name character string indicating the name of the survey being processed (must be `"BL-Lockdown"`, `"BL-Short"`, or `"BL-Long-2"`).
#' 
#' @importFrom dplyr if_any
#'
#' @author Gonzalo Garcia-Castro
#' 
#' @noRd
#' @keywords internal
#' 
#' @md
process_survey <- function(raw, participants_tmp, survey_name) {
    words_cat <- select(raw[[6]], session, created_cat = created, ended_cat = ended)
    words_spa <- select(raw[[7]], session, created_spa = created, ended_spa = ended)
    
    raw_tmp <- raw %>%
        lapply(select, -one_of(c("created", "modified", "ended", "expired"))) %>%
        # if a single session ID has multiple entries, select most recent
        reduce(inner_join, by = join_by(session), multiple = "all") %>%
        mutate(
            code = fix_code(code),
            survey_name = .env$survey_name,
            version = ifelse(survey_name=="long",
                             survey_name,
                             paste(survey_name,
                                   trimws(tolower(version), whitespace = "[\\h\\v]"),
                                   sep = "-"
                             )
            )
        ) %>%
        left_join(participants_tmp, by = join_by(code))
    
    items_to_keep <- c(
        "time", "code", "study", "version", "randomisation",
        "date_birth", "date_started", "date_finished", "sex",
        "edu_parent1", "edu_parent2", "language_doe_catalan",
        "language_doe_spanish", "language_doe_others"
    )
    
    # process data
    processed <- raw_tmp %>%
        select(-matches("lockdown")) %>%
        left_join(words_cat, by = join_by(session), multiple = "all") %>%
        left_join(words_spa, by = join_by(session), multiple = "all") %>%
        filter(code %in% participants_tmp$code,
               !if_any(matches("created_|ended_"), is.na)) %>% 
        mutate(
            across(c(matches("created_|ended_"), date_birth), as.POSIXct),
            across(starts_with("language_doe"), function(x) ifelse(is.na(x), 0, x)),
            survey_name = .env$survey_name,
            date_started = get_time_stamp(ended_cat, ended_spa, which = "first"),
            date_finished = get_time_stamp(ended_cat, ended_spa, which = "last"),
            language_doe_catalan = get_doe(matches("catalan")),
            language_doe_spanish = get_doe(matches("spanish")),
            language_doe_others = 100 - rowSums(across(c(
                language_doe_catalan,
                language_doe_spanish
            )))
        ) %>%
        arrange(desc(date_finished)) %>%
        distinct(session, .keep_all = TRUE) %>%
        rename(
            edu_parent1 = demo_parent1,
            edu_parent2 = demo_parent2
        ) %>%
        select(
            starts_with("id"),
            one_of(items_to_keep),
            starts_with("cat_"),
            starts_with("spa_")
        ) %>%
        pivot_longer(
            cols = matches("cat_|spa_"),
            names_to = "item",
            values_to = "response"
        ) %>%
        rename_with(function(x) gsub("language_", "", x), everything()) %>%
        mutate(
            language = ifelse(grepl("cat_", item), "Catalan", "Spanish"),
            sex = ifelse(sex == 1, "Male", "Female"),
            across(
                starts_with("edu_"),
                function(x) na_if(x, "")
            )
        ) %>%
        arrange(desc(date_finished)) %>%
        distinct(id, code, item, .keep_all = TRUE)
    
    return(processed)
}

#' Collect survey data
#'
#' @importFrom cli cli_alert_success
#' 
#' @param version Character string indicating the name fo the formr run (must be one of "lockdown", "long", or "short")
#' @param participants Participants dataset, as returned by [bvq::bvq_participants()]
#' @param ... Unused.
#' 
#' @author Gonzalo Garcia-Castro
#' 
#' @noRd
#' @keywords internal
#' 
#' @md
collect_survey <- function(version, participants, ...) {
    
    # validate version name
    survey_options <- c("long", "short", "lockdown")
    if (!(version %in% survey_options)) {
        cli_abort("survey must be one of {survey_options}")
    }
    
    # get survey names
    survey_names <- c("_log", "_welcome", "_consent", "_demo", "_language", 
                      "_words_catalan", "_words_spanish")
    
    # get survey names
    surveys <- paste0("bilexicon_", version, "_0", c(1:6, 6), survey_names) 
    if (version=="long") {
        surveys <- gsub("_long", "", surveys)
        surveys <- gsub("catalan", "cat", surveys)
        surveys <- gsub("spanish", "spa", surveys)
    }
    
    # process participant info
    if (missing(participants)) participants <- bvq_participants()
    participants_tmp <- participants[participants$version %in% version, ]
    if (version=="long") {
        participants_tmp <- participants_tmp[participants_tmp$randomisation=="2", ]
    }
    participants_tmp <- participants_tmp[, colnames(participants_tmp)!="version"]
    
    # download and process survey data
    raw <- download_surveys(surveys) # fetch responses
    # fix Spanish dataframe colnames
    colnames(raw[[7]]) <- gsub("cat_", "spa_", colnames(raw[[7]])) 
    raw[[1]] <- fix_logs_df(raw, participants_tmp) # fix logs dataframe
    processed <- process_survey(raw, participants_tmp, version)
    
    if (interactive()) {
        n_responses <- nrow(distinct(processed, code))
        msg <- "{version} updated: {n_responses} response{?s} retrieved"
        cli_alert_success(msg)
    }
    
    return(processed)
}


#' Fix logs dataframe
#' 
#' @param raw Named list with the contents of the surveys, as returned by [bvq::download_surveys()].
#' 
#' @author Gonzalo Garcia-Castro
#' 
#' @noRd
#' @keywords internal
#'
#' @md
fix_logs_df <- function(raw, participants_tmp) {
    
    # fix logs dataframe
    logs <- raw[[1]]
    names(logs)[names(logs) == "bl_code"] <- "code"
    # variables to correct types
    logs[c("created", "ended")] <- lapply(logs[c("created", "ended")], as.POSIXct)
    # remove if missing any critical variable
    logs$code <- fix_code(ifelse(logs$code=="", NA_character_, logs$code))
    logs <- logs[!is.na(logs$code) & !is.na(logs$ended) & !is.na(logs$session), ]
    # fix codes known to be wrong
    logs <- fix_code_raw(logs)
    # remove codes not included in participants
    logs <- logs[logs$code %in% participants_tmp$code, ]
    # get only last response of each code
    logs <- logs[order(logs$created, decreasing = TRUE), , drop = FALSE]
    logs <- logs[!duplicated(logs$code), , drop = FALSE]
    
    return(logs)
    
}
