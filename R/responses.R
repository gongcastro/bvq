#' Retrieve and update local and/or remote data from formr
#'
#' This function generates a data frame with participant's responses to each
#' item, along with some session-specific metadata. It takes `participants`
#' (the output of [bvq::bvq_participants()]) and `runs` (a character vector that can
#' take zero, one, or multiple of the following values: `"formr2"`,
#' `"formr-short"`, `"formr-lockdown"`) as arguments.
#' @import dplyr
#' @importFrom tidyr drop_na
#' @importFrom lubridate as_date
#' @importFrom formr formr_connect
#' @importFrom stats time
#' 
#' @export bvq_responses
#' 
#' @param participants Participants data frame, as generated by
#'   [bvq::bvq_participants()]. If `NULL` (default), [bvq::bvq_participants()] is run.
#' @param longitudinal Should longitudinal data be included? If `"all"`
#'   (default), all responses (including repeated measures) are included. If
#'   "no", participants with more than one responses to the questionnaire
#'   (regardless of the version) are excluded. If `"first"`, only the first
#'   response of each participant is included. If `"last"`, only the last
#'   response of each participant is included. If `"only"`, only responses with
#'   repeated measures are included.
#' @param ... Unused.
#' 
#' @returns A data frame (actually, a [tibble::tibble] containing participant's
#'   responses to each item, along with some session-specific metadata. The
#'   output includes the following variables:
#' * id: a character string with five digits indicating a participant's identifier in the database from the [Laboratori de Recerca en Inf√†ncia](https://www.upf.edu/web/cbclab) at Universitat Pompeu Fabra. This value is always the same for each participant, so that different responses from the same participant share the same `id`.
#' * time: a numeric value indicating how many times a given participant has been sent the questionnaire, regardless of whether they completed it or not.
#' * code: a character string identifying a single response to the questionnaire. This value is always unique for each response to the questionnaire, even for responses from the same participant.
#' * study: a character string indicating the study in which the participant was invited to fill in the questionnaire. Frequently, participants that filled in the questionnaire came to the lab to participant in a study, and were then invited to fill in the questionnaire later. This value indicates what study each participant was tested in before being sent the questionnaire.
#' * version: a character string indicating what version of the questionnaire a given participant filled in. Different versions may contain a different subset of items, and the administration instructions might vary slightly (see formr questionnaire templates in the [GitHub repository](https://github.com/gongcastro/bvq)). Also, different versions were designed, implemented, and administrated at different time points (e.g., before/during/after the COVID-related lockdown).
#' * item: character string indicating the item identifier (e.g., `spa_mesa`). This value is unique for each item. Responses to the same item from different participants are linked by the same `item` value.
#' * response: integer indicating the participant's response to a give item: `1` if `"No"` (the participant does not understand or produce the word), `2` if "Understands" (the participants understands the word), or `3` if "Understands and Says" (the participant understands and produces the item).
#' * date_birth: a date value (see lubridate package) in `yyyy/mm/dd` format indicating participants birth date.
#' * date_started: a date value (see lubridate package) in `yyyy/mm/dd` format indicating when participants logged to the questionnaire for the first time.
#' * date_finished: a date value (see lubridate package) in `yyyy/mm/dd` format indicating when participants logged to the questionnaire for the last time.
#' * sex: a character string indicating participants' biological sex, as reported by the parents.
#' * edu_parent1: a character string indicating the educational attainment of one of the parents/caretakers.
#' * edu_parent2: a character string indicating the educational attainment of the other parent/caretaker, if any.
#' * doe_spanish: a numeric value ranging from 0 to 1 indicating participants' daily exposure to Spanish, as estimated by parents/caregivers This value aggregates participants' exposure to any variant of Spanish (e.g., European and American Spanish).
#' * doe_catalan: a numeric value ranging from 0 to 1 indicating participants' daily exposure to Catalan, as estimated by parents/caregivers This value aggregates participants' exposure to any variant of Catalan (e.g., Catalan from Majorca or Barcelona).
#' * doe_others: a numeric value ranging from 0 to 1 indicating participants' daily exposure to languages other than Spanish or Catalan, as estimated by parents/caretakers, aggregating participants' exposure to all those other languages (e.g., Norwegian, Arab, Swahili).
#' * randomisation: a character string indicating the specific list of items a participant was assigned to. Only applies in the case of short versions of BVQ, such as BL-Short, BL-Short-2 or BL-Lockdown, where the list of items was partitioned into several versions.
#'
#' @author Gonzalo Garcia-Castro
#' @md
bvq_responses <- function(participants = NULL,
                          longitudinal = "all",
                          ...) {
    
    # retrieve data from formr
    formr2 <- import_formr2() # formr2
    formr_lockdown <- import_formr_lockdown() # formr-lockdown
    formr_short <- import_formr_short() # formr-lockdown
    
    responses <- list(formr1, formr2, formr_short, formr_lockdown) %>%
        bind_rows() %>%
        distinct(id, code, item, .keep_all = TRUE) %>%  
        mutate(across(c(starts_with("date_"), time_stamp), as_date),
               date_finished = coalesce(time_stamp, date_finished),
               time = ifelse(is.na(time), 1, time),
               version = trimws(version, whitespace = "[\\h\\v]")) %>%
        fix_item() %>%
        fix_doe() %>%
        mutate(across(starts_with("doe_"), function(x) x / 100)) %>%
        fix_sex() %>%
        mutate(study = ifelse(is.na(study), "BiLexicon", study)) %>% 
        fix_id_exp() %>%
        drop_na(date_finished) %>%
        get_longitudinal(longitudinal = longitudinal) %>%
        arrange(desc(date_finished)) %>% 
        select(id, time, code, study,
               version, randomisation,
               starts_with("date_"),
               item, response, sex,
               starts_with("doe_"),
               starts_with("edu_"))
    
    return(responses)
}
